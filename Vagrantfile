Vagrant.configure("2") do |config|
  config.vm.box = "generic/alpine312"
  config.vm.hostname = "pentesting-vm"

  config.vm.provider "virtualbox" do |vb|
    vb.name = "pentesting-vm"
    vb.gui = true
  end

  config.ssh.forward_agent = true
  config.ssh.forward_x11 = true

  config.vm.provision "shell", inline: <<-SHELL
    apk update && \
    apk add \
      bzip2 \
      coreutils \
      curl \
      g++ \
      gcc \
      go \
      git \
      libffi-dev \
      libxml2-dev \
      libxslt-dev \
      make \
      nikto \
      nmap \
      openjdk8 \
      openssl-dev \
      python3-dev \
      py3-pip \
      tar \
      unzip
    go get github.com/OJ/gobuster
    python3 -m pip install --upgrade pip && \
    pip install mitmproxy sqlmap sslyze

    # Apktool
    mkdir -p /opt/apktool && \
    cd /opt/apktool && \
      curl -LO https://github.com/iBotPeaches/Apktool/releases/download/v2.4.1/apktool_2.4.1.jar && \
      curl -LO https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool && \
      mv apktool_2.4.1.jar apktool.jar && \
      chmod +x apktool

    # dex2jar
    cd /opt && \
      curl -LO https://github.com/pxb1988/dex2jar/releases/download/2.0/dex-tools-2.0.zip && \
      unzip dex-tools-2.0.zip && \
      mv dex2jar-2.0 dex2jar

    # jd-cmd
    mkdir -p /opt/jd-cmd && \
    cd /opt/jd-cmd && \
      curl -LO https://github.com/kwart/jd-cmd/releases/download/jd-cmd-1.1.0.final/jd-cli-1.1.0.final-dist.tar.gz && \
      tar -xf jd-cli-1.1.0.final-dist.tar.gz && \
      rm -rf jd-cli-1.1.0.final-dist.tar.gz && \
      chmod +x jd-cli

    # MobSF
    git clone https://github.com/mobsf/mobile-security-framework-mobsf /opt/mobsf
    cd /opt/mobsf && \
      ./setup.sh && \
      ln -sf /opt/mobsf/run.sh /usr/local/bin/mobsf

    # theHarvester
    git clone https://github.com/laramies/theharvester /opt/theharvester
    cd /opt/theharvester && \
      python3 -m pip install -r requirements/base.txt && \
      ln -sf /opt/theharvester/theHarvester.py /usr/local/bin/theHarvester

    # OWASP ZAP
    cd /opt && \
      curl -LO https://github.com/zaproxy/zaproxy/releases/download/v2.9.0/ZAP_2.9.0_Linux.tar.gz && \
      tar -xf ZAP_2.9.0_Linux.tar.gz && \
      mv ZAP_2.9.0 zap && \
      rm -rf ZAP_2.9.0_Linux.tar.gz && \
      ln -sf /opt/zap/zap.sh /usr/local/bin/zap

    # Fix permissions
    chown -R root:root /opt
  SHELL

end
